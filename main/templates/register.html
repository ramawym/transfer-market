{% extends 'base.html' %} {% load static %} {% block meta %}
<title>Register - Transfer Market</title>
{% endblock meta %} {% block content %}
<div class="form-style">
  <div
    class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-50 flex items-center justify-center p-8"
  >
    <div class="max-w-md w-full relative z-10">
      <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-xl">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Join Us</h2>
          <p class="text-gray-600">Create your Transfer Market account</p>
        </div>

        <div id="error-container" class="mb-6"></div>

        <form id="register_form" class="space-y-5">
          {% csrf_token %}
          <div>
            <label
              for="username"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Username</label
            >
            <div class="relative">
              <input
                id="username"
                name="username"
                type="text"
                required
                class="pl-10"
                placeholder="Choose a username"
              />
            </div>
          </div>

          <div>
            <label
              for="password"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Password</label
            >
            <div class="relative">
              <input
                id="password"
                name="password"
                type="password"
                required
                class="pl-10"
                placeholder="Create a password"
              />
            </div>
          </div>

          <div>
            <label
              for="password2"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Confirm Password</label
            >
            <div class="relative">
              <input
                id="password2"
                name="password2"
                type="password"
                required
                class="pl-10"
                placeholder="Confirm your password"
              />
            </div>
          </div>

          <button
            type="submit"
            class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 hover:shadow-lg transition-all flex items-center justify-center"
          >
            Create Account
          </button>
        </form>
        <div class="mt-6 text-center pt-6 border-t border-gray-200">
          <p class="text-gray-600 text-sm">
            Already have an account?
            <a
              href="{% url 'main:login' %}"
              class="text-blue-600 hover:text-blue-700 font-semibold"
            >
              Login
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("register_form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const errorContainer = document.getElementById("error-container");
      errorContainer.innerHTML = ""; // Bersihkan error sebelumnya

      const formData = new FormData(this);

      // Ubah nama field 'password' menjadi 'password1' agar sesuai dengan UserCreationForm Django
      if (formData.has("password")) {
        formData.append("password1", formData.get("password"));
        formData.delete("password");
      }

      try {
        const response = await fetch("{% url 'main:register_ajax' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: formData,
        });

        const result = await response.json();

        if (result.status === "success") {
          // Tampilkan toast berhasil
          showToast(result.message, "success");
          // Arahkan ke halaman login setelah jeda
          setTimeout(() => {
            window.location.href = "{% url 'main:login' %}";
          }, 1500);
        } else {
          // Tampilkan semua error per-field di dalam container
          for (const field in result.errors) {
            const errorDiv = document.createElement("div");
            errorDiv.className =
              "px-4 py-3 rounded-lg text-sm border bg-red-50 border-red-200 text-red-700 mb-2 flex items-start";
            
            // Mengubah nama field menjadi lebih rapi (contoh: 'password2' -> 'Password2')
            let fieldName = field.charAt(0).toUpperCase() + field.slice(1).replace(/_/g, ' ');
            if (fieldName === '__all__') {
                fieldName = 'Error';
            }

            errorDiv.innerHTML = `<span><strong>${fieldName}:</strong> ${result.errors[field]}</span>`;
            errorContainer.appendChild(errorDiv);
          }
        }
      } catch (error) {
        showToast("Could not connect to the server.", "error");
      }
    });
</script>
{% endblock content %}